openapi: 3.1.0
info:
  title: Podcast Server API
  description: |
    REST API for managing podcast feeds with automatic ad detection and removal.


    This API allows you to:
    - Manage podcast feed subscriptions
    - View and manage processed episodes
    - Configure ad detection settings including Claude model selection
    - Monitor system status and trigger cleanup operations
    - Manage cross-episode ad patterns with network and podcast scope
    - Submit corrections to improve ad detection accuracy
  version: 0.1.184
  contact:
    name: Podcast Server
  license:
    name: MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: '{baseUrl}/api/v1'
    description: Custom server
    variables:
      baseUrl:
        default: http://localhost:8000
        description: Base URL of the podcast server

tags:
  - name: Auth
    description: Authentication management (optional password protection)
  - name: Feeds
    description: Podcast feed management
  - name: Episodes
    description: Episode data and transcripts
  - name: Processing
    description: Processing queue management
  - name: Patterns
    description: Cross-episode ad pattern management
  - name: Sponsors
    description: Sponsor name normalization
  - name: Settings
    description: Application settings and configuration
  - name: Status
    description: Real-time processing status
  - name: History
    description: Processing history and statistics
  - name: System
    description: System status and maintenance

paths:
  /auth/status:
    get:
      tags:
        - Auth
      summary: Check authentication status
      description: |
        Returns whether password protection is enabled and if the current session is authenticated.
        This endpoint is always accessible without authentication.
      operationId: getAuthStatus
      responses:
        '200':
          description: Authentication status
          content:
            application/json:
              schema:
                type: object
                properties:
                  passwordSet:
                    type: boolean
                    description: Whether a password is configured
                  authenticated:
                    type: boolean
                    description: Whether current session is authenticated

  /auth/login:
    post:
      tags:
        - Auth
      summary: Login with password
      description: Authenticate with the configured password. Rate limited to 5 attempts per minute.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - password
              properties:
                password:
                  type: string
                  description: The application password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  authenticated:
                    type: boolean
                  message:
                    type: string
        '401':
          description: Invalid password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logout and clear session
      description: Clears the current session, requiring re-authentication.
      operationId: logout
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  authenticated:
                    type: boolean
                  message:
                    type: string

  /auth/password:
    put:
      tags:
        - Auth
      summary: Set or change password
      description: |
        Set or change the application password. Rate limited to 3 attempts per hour.

        - If no password is set, creates a new password
        - If password is set, requires current password for verification
        - Set newPassword to empty string to remove password protection
        - Minimum password length: 8 characters
      operationId: setPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newPassword
              properties:
                currentPassword:
                  type: string
                  description: Current password (required if password is already set)
                newPassword:
                  type: string
                  description: New password (min 8 chars, or empty to remove protection)
      responses:
        '200':
          description: Password updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  passwordSet:
                    type: boolean
        '400':
          description: Invalid request (password too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Current password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /feeds:
    get:
      tags:
        - Feeds
      summary: List all feeds
      description: Returns a list of all configured podcast feeds with metadata
      operationId: listFeeds
      responses:
        '200':
          description: List of feeds
          content:
            application/json:
              schema:
                type: object
                properties:
                  feeds:
                    type: array
                    items:
                      $ref: '#/components/schemas/Feed'
    post:
      tags:
        - Feeds
      summary: Add a new feed
      description: Add a new podcast feed by providing the source RSS URL
      operationId: addFeed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sourceUrl
              properties:
                sourceUrl:
                  type: string
                  format: uri
                  description: URL of the source RSS feed
                  example: https://feeds.example.com/podcast.xml
                slug:
                  type: string
                  description: Optional custom slug (auto-generated if not provided)
                  example: my-podcast
      responses:
        '201':
          description: Feed created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  slug:
                    type: string
                  sourceUrl:
                    type: string
                  feedUrl:
                    type: string
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Feed with slug already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /feeds/{slug}:
    get:
      tags:
        - Feeds
      summary: Get a single feed
      description: Returns details for a specific podcast feed
      operationId: getFeed
      parameters:
        - $ref: '#/components/parameters/slug'
      responses:
        '200':
          description: Feed details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feed'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Feeds
      summary: Delete a feed
      description: Delete a podcast feed and all associated data
      operationId: deleteFeed
      parameters:
        - $ref: '#/components/parameters/slug'
      responses:
        '200':
          description: Feed deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  slug:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags:
        - Feeds
      summary: Update feed settings
      description: Update podcast feed settings like network override, DAI platform, and processing overrides
      operationId: updateFeed
      parameters:
        - $ref: '#/components/parameters/slug'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                networkIdOverride:
                  type:
                    - string
                    - 'null'
                  description: Override network ID (null to use auto-detected)
                daiPlatform:
                  type: string
                  description: DAI platform identifier (e.g., megaphone, acast)
                audioAnalysisOverride:
                  type:
                    - boolean
                    - 'null'
                  description: Override audio analysis setting (null uses global)
                autoProcessOverride:
                  type:
                    - boolean
                    - 'null'
                  description: Override auto-process setting (null uses global)
      responses:
        '200':
          description: Feed updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Feed'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/refresh:
    post:
      tags:
        - Feeds
      summary: Refresh a single feed
      description: Fetch the latest RSS feed and update episode list
      operationId: refreshFeed
      parameters:
        - $ref: '#/components/parameters/slug'
      responses:
        '200':
          description: Feed refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  slug:
                    type: string
                  message:
                    type: string
                  episodeCount:
                    type: integer
                  lastRefreshed:
                    type: string
                    format: date-time
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/refresh:
    post:
      tags:
        - Feeds
      summary: Refresh all feeds
      description: Refresh RSS feeds for all configured podcasts
      operationId: refreshAllFeeds
      responses:
        '200':
          description: All feeds refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  feedCount:
                    type: integer

  /feeds/{slug}/artwork:
    get:
      tags:
        - Feeds
      summary: Get feed artwork
      description: Returns the cached podcast artwork image
      operationId: getFeedArtwork
      parameters:
        - $ref: '#/components/parameters/slug'
      responses:
        '200':
          description: Artwork image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/episodes:
    get:
      tags:
        - Episodes
      summary: List episodes for a feed
      description: Returns paginated list of episodes for a podcast
      operationId: listEpisodes
      parameters:
        - $ref: '#/components/parameters/slug'
        - name: status
          in: query
          description: Filter by episode status
          schema:
            type: string
            enum: [all, pending, processing, processed, failed]
            default: all
        - name: limit
          in: query
          description: Maximum number of episodes to return
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          description: Number of episodes to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of episodes
          content:
            application/json:
              schema:
                type: object
                properties:
                  episodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/EpisodeSummary'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/episodes/{episodeId}:
    get:
      tags:
        - Episodes
      summary: Get episode details
      description: Returns detailed information about an episode including ad markers
      operationId: getEpisode
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      responses:
        '200':
          description: Episode details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EpisodeDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/episodes/{episodeId}/transcript:
    get:
      tags:
        - Episodes
      summary: Get episode transcript
      description: Returns the full transcript text for an episode
      operationId: getEpisodeTranscript
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      responses:
        '200':
          description: Episode transcript
          content:
            application/json:
              schema:
                type: object
                properties:
                  episodeId:
                    type: string
                  transcript:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/episodes/{episodeId}/reprocess:
    post:
      tags:
        - Episodes
      summary: Force reprocess an episode
      description: |
        Deletes all cached data (audio, transcript, ads) and reprocesses the episode.
        Supports two modes:
        - `reprocess` (default): Uses learned patterns from the pattern database plus Claude analysis
        - `full`: Skips the pattern database entirely for a fresh Claude-only analysis

        Reprocessed episodes are prioritized in the processing queue.
      operationId: reprocessEpisode
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  enum: [reprocess, full]
                  default: reprocess
                  description: |
                    Processing mode:
                    - reprocess: Use pattern DB + Claude (leverages learned patterns)
                    - full: Claude only, skip pattern DB (fresh analysis)
      responses:
        '200':
          description: Episode reprocessing started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  status:
                    type: string
                    enum: [completed, processing]
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /feeds/{slug}/episodes/{episodeId}/regenerate-chapters:
    post:
      tags:
        - Episodes
      summary: Regenerate chapters from transcript
      description: |
        Regenerates chapters for an episode using the existing VTT transcript.
        Uses AI topic detection to identify natural chapter boundaries without
        requiring full reprocessing. The VTT transcript must already exist.
      operationId: regenerateChapters
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      responses:
        '200':
          description: Chapters regenerated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Chapters regenerated
                  episodeId:
                    type: string
                  chapterCount:
                    type: integer
                  chapters:
                    type: array
                    items:
                      type: object
                      properties:
                        startTime:
                          type: integer
                          description: Chapter start time in milliseconds
                        title:
                          type: string
        '400':
          description: No VTT transcript available (full reprocess required)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /feeds/{slug}/episodes/{episodeId}/retry-ad-detection:
    post:
      tags:
        - Episodes
      summary: Retry ad detection
      description: |
        Re-runs ad detection using the existing transcript. Faster than full
        reprocess since it skips transcription. Use when ad detection failed
        due to API errors or when you want to try with updated prompts.
      operationId: retryAdDetection
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      responses:
        '200':
          description: Ad detection retry completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  adsDetected:
                    type: integer
                  status:
                    type: string
        '400':
          description: Episode has no transcript (must use reprocess instead)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /feeds/{slug}/episodes/{episodeId}/cancel:
    post:
      tags:
        - Processing
      summary: Cancel episode processing
      description: |
        Cancel an episode stuck in processing status and reset it to pending.
        Use this when an episode is stuck due to a crashed worker or other issues.
      operationId: cancelEpisodeProcessing
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      responses:
        '200':
          description: Episode processing canceled
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  episodeId:
                    type: string
                  slug:
                    type: string
        '400':
          description: Episode is not in processing status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /feeds/{slug}/episodes/{episodeId}/corrections:
    post:
      tags:
        - Episodes
      summary: Submit ad corrections
      description: |
        Submit corrections for detected ads in an episode. This feedback improves
        the cross-episode pattern database for better future detection.

        Actions:
        - confirm: Mark detection as correct (creates/updates pattern)
        - reject: Mark as false positive. Stores transcript text for cross-episode matching -
          similar text in future episodes of the same podcast will be automatically excluded
          using TF-IDF similarity matching (threshold: 0.75)
        - adjust: Correct ad boundaries. Also creates patterns from the adjusted boundaries
          (like confirm), ensuring accurate pattern text is learned from the corrected segment
      operationId: submitCorrections
      parameters:
        - $ref: '#/components/parameters/slug'
        - $ref: '#/components/parameters/episodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - corrections
              properties:
                corrections:
                  type: array
                  items:
                    $ref: '#/components/schemas/AdCorrection'
      responses:
        '200':
          description: Corrections submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  processed:
                    type: integer
                    description: Number of corrections processed
                  patternsCreated:
                    type: integer
                    description: New patterns created from confirmations
                  patternsUpdated:
                    type: integer
                    description: Existing patterns updated
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /episodes/processing:
    get:
      tags:
        - Processing
      summary: List processing episodes
      description: Returns all episodes currently in processing status across all feeds
      operationId: listProcessingEpisodes
      responses:
        '200':
          description: List of processing episodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProcessingEpisode'

  /patterns:
    get:
      tags:
        - Patterns
      summary: List ad patterns
      description: |
        Returns all ad patterns from the cross-episode pattern database.
        Patterns are organized by scope (global, network, podcast) and can be
        filtered to show only active patterns.
      operationId: listPatterns
      parameters:
        - name: scope
          in: query
          description: Filter by pattern scope
          schema:
            type: string
            enum: [all, global, network, podcast]
            default: all
        - name: active_only
          in: query
          description: Only return active patterns
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of patterns
          content:
            application/json:
              schema:
                type: object
                properties:
                  patterns:
                    type: array
                    items:
                      $ref: '#/components/schemas/Pattern'

  /patterns/{patternId}:
    get:
      tags:
        - Patterns
      summary: Get a single pattern
      description: Returns details for a specific ad pattern
      operationId: getPattern
      parameters:
        - $ref: '#/components/parameters/patternId'
      responses:
        '200':
          description: Pattern details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pattern'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags:
        - Patterns
      summary: Update a pattern
      description: Update pattern properties like active status, sponsor, or disabled reason
      operationId: updatePattern
      parameters:
        - $ref: '#/components/parameters/patternId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_active:
                  type: boolean
                  description: Whether the pattern is active
                sponsor:
                  type: string
                  description: Sponsor name for this pattern
                disabled_reason:
                  type: string
                  description: Reason for disabling the pattern
      responses:
        '200':
          description: Pattern updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  pattern:
                    $ref: '#/components/schemas/Pattern'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - Patterns
      summary: Delete a pattern
      description: Permanently delete an ad pattern from the database
      operationId: deletePattern
      parameters:
        - $ref: '#/components/parameters/patternId'
      responses:
        '200':
          description: Pattern deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          $ref: '#/components/responses/NotFound'

  /patterns/backfill-false-positives:
    post:
      tags:
        - Patterns
      summary: Backfill false positive texts
      description: |
        Backfill transcript text for existing false positive corrections that were
        created before cross-episode matching was enabled. This extracts the
        transcript text from each correction's original boundaries and stores it
        for future cross-episode matching.
      operationId: backfillFalsePositiveTexts
      responses:
        '200':
          description: Backfill completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  updated:
                    type: integer
                    description: Number of corrections updated with transcript text
                  skipped:
                    type: integer
                    description: Number of corrections skipped (missing transcript, too short)
        '500':
          $ref: '#/components/responses/ServerError'

  /patterns/deduplicate:
    post:
      tags:
        - Patterns
      summary: Deduplicate patterns
      description: Manually trigger deduplication of similar patterns in the database
      operationId: deduplicatePatterns
      responses:
        '200':
          description: Deduplication completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  removed_count:
                    type: integer
                    description: Number of duplicate patterns removed
        '500':
          $ref: '#/components/responses/ServerError'

  /patterns/export:
    get:
      tags:
        - Patterns
      summary: Export patterns
      description: Export all patterns as JSON for backup or transfer
      operationId: exportPatterns
      responses:
        '200':
          description: Exported patterns
          content:
            application/json:
              schema:
                type: object
                properties:
                  exportedAt:
                    type: string
                    format: date-time
                  version:
                    type: string
                  patterns:
                    type: array
                    items:
                      $ref: '#/components/schemas/Pattern'

  /patterns/import:
    post:
      tags:
        - Patterns
      summary: Import patterns
      description: Import patterns from a JSON export file
      operationId: importPatterns
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - patterns
              properties:
                patterns:
                  type: array
                  items:
                    $ref: '#/components/schemas/Pattern'
                merge:
                  type: boolean
                  default: true
                  description: Merge with existing patterns (true) or replace all (false)
      responses:
        '200':
          description: Patterns imported
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  imported:
                    type: integer
                  skipped:
                    type: integer

  /networks:
    get:
      tags:
        - Feeds
      summary: List known podcast networks
      description: Returns list of known podcast networks for network-level pattern matching
      operationId: listNetworks
      responses:
        '200':
          description: List of networks
          content:
            application/json:
              schema:
                type: object
                properties:
                  networks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Network'

  /sponsors:
    get:
      tags:
        - Sponsors
      summary: List unique sponsors
      description: Returns list of unique sponsor names from the pattern database
      operationId: listSponsors
      responses:
        '200':
          description: List of sponsors
          content:
            application/json:
              schema:
                type: object
                properties:
                  sponsors:
                    type: array
                    items:
                      type: string

  /sponsors/normalizations:
    get:
      tags:
        - Sponsors
      summary: Get sponsor normalizations
      description: Returns mapping of sponsor name variations to canonical names
      operationId: getSponsorNormalizations
      responses:
        '200':
          description: Sponsor normalizations
          content:
            application/json:
              schema:
                type: object
                properties:
                  normalizations:
                    type: object
                    additionalProperties:
                      type: string
                    description: Map of variation to canonical name
    post:
      tags:
        - Sponsors
      summary: Update sponsor normalizations
      description: Add or update sponsor name normalization mappings
      operationId: updateSponsorNormalizations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                normalizations:
                  type: object
                  additionalProperties:
                    type: string
                  description: Map of variation to canonical name
      responses:
        '200':
          description: Normalizations updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /status:
    get:
      tags:
        - Status
      summary: Get current processing status
      description: Returns current processing status including active episode and queue depth
      operationId: getStatus
      responses:
        '200':
          description: Current status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessingStatus'

  /status/stream:
    get:
      tags:
        - Status
      summary: Real-time status stream (SSE)
      description: |
        Server-Sent Events endpoint for real-time processing status updates.
        Connect to receive live updates about processing progress, including
        stage changes and percentage completion.
      operationId: streamStatus
      responses:
        '200':
          description: SSE stream of status updates
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSE events with JSON data containing:
                  - processing: boolean
                  - episode: object with title, slug, episodeId
                  - stage: current processing stage
                  - progress: percentage (0-100)
                  - queue_depth: number of pending episodes

  /history:
    get:
      tags:
        - History
      summary: Get processing history
      description: Returns processing history with pagination and filtering
      operationId: getProcessingHistory
      parameters:
        - name: status
          in: query
          description: Filter by processing status
          schema:
            type: string
            enum: [all, completed, failed]
            default: all
        - name: podcast_id
          in: query
          description: Filter by podcast ID
          schema:
            type: integer
        - name: limit
          in: query
          description: Maximum number of entries to return
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          description: Number of entries to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Processing history
          content:
            application/json:
              schema:
                type: object
                properties:
                  history:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProcessingHistoryEntry'
                  total:
                    type: integer
                    description: Total number of history entries matching the filter
                  totalPages:
                    type: integer
                    description: Total number of pages available
                  limit:
                    type: integer
                  offset:
                    type: integer

  /history/stats:
    get:
      tags:
        - History
      summary: Get processing statistics
      description: Returns aggregate statistics from processing history
      operationId: getProcessingHistoryStats
      responses:
        '200':
          description: Processing statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_processed:
                    type: integer
                  completed:
                    type: integer
                  failed:
                    type: integer
                  total_ads_detected:
                    type: integer
                  avg_processing_time:
                    type:
                      - number
                      - 'null'
                    description: Average processing time in seconds
                  podcasts:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        title:
                          type: string

  /history/export:
    get:
      tags:
        - History
      summary: Export processing history
      description: Export processing history as CSV or JSON file
      operationId: exportProcessingHistory
      parameters:
        - name: format
          in: query
          description: Export format
          schema:
            type: string
            enum: [csv, json]
            default: csv
        - name: status
          in: query
          description: Filter by processing status
          schema:
            type: string
            enum: [all, completed, failed]
            default: all
        - name: podcast_id
          in: query
          description: Filter by podcast ID
          schema:
            type: integer
      responses:
        '200':
          description: Exported history file
          content:
            text/csv:
              schema:
                type: string
            application/json:
              schema:
                type: object
                properties:
                  history:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProcessingHistoryEntry'

  /settings:
    get:
      tags:
        - Settings
      summary: Get all settings
      description: Returns current application settings including ad detection configuration
      operationId: getSettings
      responses:
        '200':
          description: Current settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settings'

  /settings/ad-detection:
    put:
      tags:
        - Settings
      summary: Update ad detection settings
      description: Update Claude model, system prompt, or multi-pass detection
      operationId: updateAdDetectionSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                systemPrompt:
                  type: string
                  description: System prompt for Claude ad detection (first pass)
                secondPassPrompt:
                  type: string
                  description: System prompt for second pass ad detection (subtle/baked-in ads)
                claudeModel:
                  type: string
                  description: Claude model ID to use for first pass ad detection
                  example: claude-sonnet-4-5-20250929
                secondPassModel:
                  type: string
                  description: Claude model ID for second pass ad detection (can differ from first pass)
                  example: claude-sonnet-4-5-20250929
                multiPassEnabled:
                  type: boolean
                  description: Enable dual-pass ad detection for improved accuracy
                audioAnalysisEnabled:
                  type: boolean
                  description: Enable audio analysis (volume, music, speaker) for improved ad detection
                whisperModel:
                  type: string
                  description: Whisper model for transcription (tiny, base, small, medium, large-v3)
                  example: small
                autoProcessEnabled:
                  type: boolean
                  description: Enable automatic processing of new episodes when feeds refresh
                minCutConfidence:
                  type: number
                  format: float
                  minimum: 0.50
                  maximum: 0.95
                  description: Minimum confidence threshold to cut an ad from audio. Lower = more aggressive (removes more potential ads), higher = more conservative
                  example: 0.80
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /settings/ad-detection/reset:
    post:
      tags:
        - Settings
      summary: Reset ad detection settings
      description: Reset all ad detection settings to their default values
      operationId: resetAdDetectionSettings
      responses:
        '200':
          description: Settings reset to defaults
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /settings/models:
    get:
      tags:
        - Settings
      summary: Get available Claude models
      description: Returns list of available Claude models for ad detection
      operationId: getAvailableModels
      responses:
        '200':
          description: List of available models
          content:
            application/json:
              schema:
                type: object
                properties:
                  models:
                    type: array
                    items:
                      $ref: '#/components/schemas/Model'

  /settings/whisper-models:
    get:
      tags:
        - Settings
      summary: Get available Whisper models
      description: Returns list of available Whisper models for transcription with resource requirements
      operationId: getWhisperModels
      responses:
        '200':
          description: List of available Whisper models
          content:
            application/json:
              schema:
                type: object
                properties:
                  models:
                    type: array
                    items:
                      $ref: '#/components/schemas/WhisperModel'

  /health:
    get:
      tags:
        - System
      summary: Health check
      description: |
        Health check endpoint for monitoring and load balancers.
        Returns 200 if healthy, 503 if unhealthy.
        Checks database connectivity, storage access, and queue availability.
      operationId: healthCheck
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy]
                  checks:
                    type: object
                    properties:
                      database:
                        type: boolean
                      storage:
                        type: boolean
                      queue_available:
                        type: boolean
                  version:
                    type: string
        '503':
          description: System is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [unhealthy]
                  checks:
                    type: object
                  version:
                    type: string

  /system/status:
    get:
      tags:
        - System
      summary: Get system status
      description: Returns system status, statistics, and configuration
      operationId: getSystemStatus
      responses:
        '200':
          description: System status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'

  /system/cleanup:
    post:
      tags:
        - System
      summary: Trigger manual cleanup
      description: Manually trigger cleanup of episodes older than retention period
      operationId: triggerCleanup
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  episodesRemoved:
                    type: integer
                  spaceFreedMb:
                    type: number

  /system/queue:
    get:
      tags:
        - System
      summary: Get auto-process queue status
      description: Returns the current status of the auto-process queue for new episodes
      operationId: getQueueStatus
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema:
                type: object
                properties:
                  pending:
                    type: integer
                    description: Episodes waiting to be processed
                  processing:
                    type: integer
                    description: Episodes currently being processed
                  completed:
                    type: integer
                    description: Episodes that completed processing
                  failed:
                    type: integer
                    description: Episodes that failed processing
                  total:
                    type: integer
                    description: Total episodes in queue

components:
  parameters:
    slug:
      name: slug
      in: path
      required: true
      description: Podcast feed slug identifier
      schema:
        type: string
        example: my-podcast

    episodeId:
      name: episodeId
      in: path
      required: true
      description: Episode identifier (MD5 hash)
      schema:
        type: string
        example: abc123def456

    patternId:
      name: patternId
      in: path
      required: true
      description: Pattern identifier (integer)
      schema:
        type: integer
        example: 42

  schemas:
    Feed:
      type: object
      properties:
        slug:
          type: string
          description: URL-safe identifier for the feed
        title:
          type: string
          description: Podcast title from RSS feed
        sourceUrl:
          type: string
          format: uri
          description: Original RSS feed URL
        feedUrl:
          type: string
          format: uri
          description: Modified RSS feed URL served by this server
        artworkUrl:
          type:
            - string
            - 'null'
          description: URL to cached artwork image
        episodeCount:
          type: integer
          description: Total number of episodes
        processedCount:
          type: integer
          description: Number of processed episodes
        lastRefreshed:
          type:
            - string
            - 'null'
          format: date-time
          description: Last RSS refresh timestamp
        createdAt:
          type: string
          format: date-time
        audioAnalysisOverride:
          type:
            - boolean
            - 'null'
          description: Override audio analysis setting for this feed (null uses global setting)
        autoProcessOverride:
          type:
            - boolean
            - 'null'
          description: Override auto-process setting for this feed (null uses global setting)

    EpisodeSummary:
      type: object
      properties:
        episodeId:
          type: string
        title:
          type: string
        status:
          type: string
          enum: [pending, processing, processed, failed]
        createdAt:
          type: string
          format: date-time
        processedAt:
          type:
            - string
            - 'null'
          format: date-time
        originalDuration:
          type:
            - number
            - 'null'
          description: Original duration in seconds
        newDuration:
          type: number
          description: Duration after ad removal in seconds
          nullable: true
        adsRemoved:
          type: integer
        timeSaved:
          type: number
          description: Seconds saved by removing ads
        error:
          type: string
          nullable: true

    EpisodeDetail:
      allOf:
        - $ref: '#/components/schemas/EpisodeSummary'
        - type: object
          properties:
            originalUrl:
              type: string
              format: uri
            processedUrl:
              type: string
              format: uri
            adMarkers:
              type: array
              description: Ads that were removed from audio (ACCEPT or REVIEW decision)
              items:
                $ref: '#/components/schemas/AdMarker'
            rejectedAdMarkers:
              type: array
              description: Ads flagged but kept in audio (REJECT decision due to low confidence, invalid duration, etc.)
              items:
                $ref: '#/components/schemas/AdMarker'
            transcriptAvailable:
              type: boolean
            adsRemovedFirstPass:
              type: integer
              description: Number of ads detected by first pass (includes merged)
            adsRemovedSecondPass:
              type: integer
              description: Number of ads detected by second pass (includes merged)

    AdMarker:
      type: object
      properties:
        start:
          type: number
          description: Start time in seconds
        end:
          type: number
          description: End time in seconds
        confidence:
          type: number
          description: Detection confidence (0.0 to 1.0)
          example: 0.95
        reason:
          type: string
          description: Reason for marking as ad
        pass:
          type:
            - integer
            - string
          description: Which detection pass found this ad (1, 2, or "merged" if both)
          example: 1
        validation:
          type: object
          description: Validation results from post-detection validation layer
          properties:
            decision:
              type: string
              enum: [ACCEPT, REVIEW, REJECT]
              description: Validation decision - ACCEPT/REVIEW are removed, REJECT stays in audio
            adjusted_confidence:
              type: number
              description: Confidence after position/content adjustments (0.0 to 1.0)
            original_confidence:
              type: number
              description: Original confidence from Claude detection
            flags:
              type: array
              items:
                type: string
              description: Validation warnings or errors
            corrections:
              type: array
              items:
                type: string
              description: Auto-corrections applied (merged ads, clamped boundaries)

    Model:
      type: object
      properties:
        id:
          type: string
          description: Model identifier
          example: claude-sonnet-4-5-20250929
        name:
          type: string
          description: Human-readable model name
          example: Claude Opus 4.5
        created:
          type: string
          format: date-time
          nullable: true

    WhisperModel:
      type: object
      properties:
        id:
          type: string
          description: Model identifier (tiny, base, small, medium, large-v3)
          example: small
        name:
          type: string
          description: Human-readable model name
          example: Small (Default)
        vram:
          type: string
          description: Estimated GPU VRAM requirement
          example: ~2GB
        speed:
          type: string
          description: Approximate transcription speed
          example: ~2-3 min/60min
        quality:
          type: string
          description: Relative quality compared to other models
          example: Better

    Settings:
      type: object
      properties:
        systemPrompt:
          type: object
          properties:
            value:
              type: string
            isDefault:
              type: boolean
        secondPassPrompt:
          type: object
          properties:
            value:
              type: string
            isDefault:
              type: boolean
        claudeModel:
          type: object
          properties:
            value:
              type: string
            isDefault:
              type: boolean
        secondPassModel:
          type: object
          properties:
            value:
              type: string
            isDefault:
              type: boolean
        multiPassEnabled:
          type: object
          properties:
            value:
              type: boolean
              description: Whether dual-pass ad detection is enabled
            isDefault:
              type: boolean
        audioAnalysisEnabled:
          type: object
          properties:
            value:
              type: boolean
              description: Whether audio analysis is enabled for ad detection
            isDefault:
              type: boolean
        whisperModel:
          type: object
          properties:
            value:
              type: string
              description: Whisper model for transcription
            isDefault:
              type: boolean
        autoProcessEnabled:
          type: object
          properties:
            value:
              type: boolean
              description: Whether auto-processing of new episodes is enabled
            isDefault:
              type: boolean
        minCutConfidence:
          type: object
          properties:
            value:
              type: number
              format: float
              description: Minimum confidence threshold to cut an ad from audio (0.50-0.95)
            isDefault:
              type: boolean
        retentionPeriodMinutes:
          type: integer
        defaults:
          type: object
          properties:
            systemPrompt:
              type: string
            secondPassPrompt:
              type: string
            claudeModel:
              type: string
            secondPassModel:
              type: string
            multiPassEnabled:
              type: boolean
            audioAnalysisEnabled:
              type: boolean
            whisperModel:
              type: string
            autoProcessEnabled:
              type: boolean
            minCutConfidence:
              type: number
              format: float

    SystemStatus:
      type: object
      properties:
        status:
          type: string
          enum: [running]
        version:
          type: string
        feeds:
          type: object
          properties:
            total:
              type: integer
        episodes:
          type: object
          properties:
            total:
              type: integer
            byStatus:
              type: object
              additionalProperties:
                type: integer
        storage:
          type: object
          properties:
            usedMb:
              type: number
            fileCount:
              type: integer
        settings:
          type: object
          properties:
            retentionPeriodMinutes:
              type: integer
            whisperModel:
              type: string
            whisperDevice:
              type: string
            baseUrl:
              type: string

    ProcessingEpisode:
      type: object
      properties:
        episodeId:
          type: string
          description: Episode identifier
        slug:
          type: string
          description: Podcast feed slug
        title:
          type: string
          description: Episode title
        podcast:
          type: string
          description: Podcast name
        startedAt:
          type:
            - string
            - 'null'
          format: date-time
          description: When processing started (if available)

    Pattern:
      type: object
      properties:
        id:
          type: integer
          description: Pattern ID
        scope:
          type: string
          enum: [global, network, podcast]
          description: Pattern scope level
        network_id:
          type:
            - string
            - 'null'
          description: Network ID for network-scoped patterns
        podcast_slug:
          type:
            - string
            - 'null'
          description: Podcast slug for podcast-scoped patterns
        text_template:
          type: string
          description: Text pattern template for matching
        sponsor:
          type:
            - string
            - 'null'
          description: Sponsor name associated with this pattern
        is_active:
          type: boolean
          description: Whether the pattern is currently active
        disabled_reason:
          type:
            - string
            - 'null'
          description: Reason for disabling the pattern
        confirmation_count:
          type: integer
          description: Number of times pattern was confirmed correct
        false_positive_count:
          type: integer
          description: Number of times pattern was marked as false positive
        last_matched_at:
          type:
            - string
            - 'null'
          format: date-time
          description: Last time this pattern matched an ad
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Network:
      type: object
      properties:
        id:
          type: string
          description: Network identifier (e.g., twit, relay_fm)
        name:
          type: string
          description: Human-readable network name

    AdCorrection:
      type: object
      required:
        - adIndex
        - action
      properties:
        adIndex:
          type: integer
          description: Index of the ad in the episode's ad list
        action:
          type: string
          enum: [confirm, reject, adjust]
          description: |
            - confirm: Mark detection as correct (creates/updates pattern)
            - reject: Mark as false positive (stores text for cross-episode exclusion)
            - adjust: Correct boundaries (also creates pattern from adjusted segment)
        sponsor:
          type: string
          description: Sponsor name to associate (for confirm/adjust actions)
        adjustedStart:
          type: number
          description: Corrected start time in seconds (required for adjust action)
        adjustedEnd:
          type: number
          description: Corrected end time in seconds (required for adjust action)

    ProcessingStatus:
      type: object
      properties:
        processing:
          type: boolean
          description: Whether an episode is currently being processed
        episode:
          type:
            - object
            - 'null'
          properties:
            title:
              type: string
            slug:
              type: string
            episodeId:
              type: string
          description: Currently processing episode details
        stage:
          type:
            - string
            - 'null'
          description: Current processing stage (e.g., transcribing, detecting_ads)
        progress:
          type:
            - number
            - 'null'
          description: Progress percentage (0-100)
        queue_depth:
          type: integer
          description: Number of episodes waiting to be processed

    ProcessingHistoryEntry:
      type: object
      properties:
        id:
          type: integer
          description: History entry ID
        podcast_id:
          type: integer
          description: Podcast ID
        podcast_slug:
          type: string
          description: Podcast slug
        podcast_title:
          type: string
          description: Podcast title
        episode_id:
          type: string
          description: Episode ID
        episode_title:
          type: string
          description: Episode title
        processed_at:
          type: string
          format: date-time
          description: When processing completed
        processing_duration_seconds:
          type:
            - number
            - 'null'
          description: Processing duration in seconds
        status:
          type: string
          enum: [completed, failed]
          description: Processing result status
        ads_detected:
          type: integer
          description: Number of ads detected
        error_message:
          type:
            - string
            - 'null'
          description: Error message if processing failed
        reprocess_number:
          type:
            - integer
            - 'null'
          description: Reprocess number (null for first processing)

    Error:
      type: object
      properties:
        error:
          type: string
        status:
          type: integer
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
