version: '3.8'

services:
  podcast-server:
    image: ttlequals0/podcast-server:latest
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      # Optional: Custom assets directory for replacement audio
      # Place your own replace.mp3 file here to customize the sound played where ads were removed
      # If not mounted, the built-in default audio marker is used
      # - ./assets:/app/assets:ro
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - WHISPER_MODEL=${WHISPER_MODEL:-small}
      - BASE_URL=${BASE_URL:-http://localhost:8000}
      - WHISPER_DEVICE=${WHISPER_DEVICE:-cuda}
      - RETENTION_PERIOD=${RETENTION_PERIOD:-1440}
      # Optional: HuggingFace token for pyannote speaker diarization
      # Required only if speaker analysis is enabled in audio analysis settings
      # IMPORTANT: You must also accept the model license at:
      # https://hf.co/pyannote/speaker-diarization-3.1
      # (log in with the HuggingFace account that owns the token)
      - HF_TOKEN=${HF_TOKEN:-}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    expose:
      - "8000"

  tunnel:
    image: cloudflare/cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - podcast-server
    restart: unless-stopped
    profiles:
      - tunnel
